-- gh-5958 Introduce on_replace_commit trigger
test_run = require('test_run')
---
...
inspector = test_run.new()
---
...
engine = inspector:get_cfg('engine')
---
...
s = box.schema.space.create('test', {engine = engine})
---
...
i = s:create_index('pk',  {type='tree', parts={{1, 'uint'}}})
---
...
result = ''
---
...
function r(t) result = result .. tostring(t) .. ' ' end
---
...
not not s:on_replace(function(old, new) r('on_replace') r(old) r(new) end)
---
- true
...
not not s:on_replace_commit(function(old, new) r('on_replace_commit') r(old) r(new) end)
---
- true
...
function test(f) result = '' f() return result end
---
...
test(function() s:replace{1, 1} end)
---
- 'on_replace nil [1, 1] on_replace_commit nil [1, 1] '
...
test(function() s:replace{1, 2} end)
---
- 'on_replace [1, 1] [1, 2] on_replace_commit [1, 1] [1, 2] '
...
test(function() box.begin() s:replace{1, 3} box.commit() end)
---
- 'on_replace [1, 2] [1, 3] on_replace_commit [1, 2] [1, 3] '
...
test(function() box.begin() s:replace{1, 4} box.rollback() end)
---
- 'on_replace [1, 3] [1, 4] '
...
test(function() box.begin() s:replace{2, 1} box.commit() end)
---
- 'on_replace nil [2, 1] on_replace_commit nil [2, 1] '
...
test(function() box.begin() s:replace{3, 1} box.rollback() end)
---
- 'on_replace nil [3, 1] '
...
s:drop()
---
...
